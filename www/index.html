<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MHV4 monitor</title>
</head>

<body>
    <h1>MHV4 monitor</h1>

    <div id="TableContainer"></div>
    <button id="applyButton">Apply</button>

    <script>
        const table_title = ["bus", "dev", "ch", "input (V)", "Voltage (V)", "Current (uA)", "about"];
        // user definition
        // NOTE: please be careful of the array size
        const mhv4_discription = ["-", "-", "-", "-",
            "-", "-", "-", "-"];
        // user definition end

        async function DisplayData() {
            try {
                const response = await fetch("/mhv4_data");
                if (!response.ok) {
                    throw new Error("failed to fetch the MHV4 data");
                }
                const data = await response.json();
                createTable(data);
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function createTable(data) {
            const container = document.getElementById('TableContainer');
            const table = document.createElement('table');
            table.setAttribute('border', '1');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            table_title.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // table data
            const tbody = document.createElement('tbody');
            const obj = JSON.parse(data);
            obj.forEach((mod, index) => {
                const row = document.createElement('tr');
                row.appendChild(createCell(mod.bus));
                row.appendChild(createCell(mod.dev));
                row.appendChild(createCell(mod.ch));

                // input field
                const inputCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.value = (mod.current) * 0.1;
                input.step = 0.1;
                input.min = 0;
                inputCell.appendChild(input);
                row.appendChild(inputCell);

                // SSE field (initially empty)
                row.appendChild(createCell(''));
                row.appendChild(createCell(''));

                row.appendChild(createCell(mhv4_discription[index]));

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        function createCell(text) {
            const cell = document.createElement('td');
            const celltext = document.createTextNode(text);
            cell.appendChild(celltext);
            return cell;
        }

        // Apply ボタンのイベントハンドラ
        document.getElementById('applyButton').addEventListener('click', () => {
            const inputs = document.querySelectorAll('table input[type="number"]');
            const values = Array.from(inputs).map(input => ({
                index: input.dataset.index,
                value: parseFloat(input.value)
            }));

            // "/send" エンドポイントにデータを送信
            fetch('/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(values)
            }).then(response => response.text())
                .then(result => {
                    console.log('Success:', result);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function setupSSE() {
            const eventSource = new EventSource('/sse');
            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                updateTable(data);
            };
        }

        function updateTable(data) {
            const table = document.querySelector('table');
            for (let i = 0; i < table.rows.length - 1; i++) {
                const row = table.rows[i + 1];
                const v_cell = row.cells[4];
                const c_cell = row.cells[5];

                v_cell.textContent = data[0][i];
                c_cell.textContent = data[1][i];
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            DisplayData();
            setupSSE();
        });

    </script>
</body>

</html>