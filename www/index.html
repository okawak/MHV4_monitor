<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="custom.css">
    <title>MHV4 monitor</title>
</head>

<body>
    <h1>MHV4 monitor</h1>

    <!--Status monitor-->
    <h2>Status (Green=ON, Red=OFF, Yellow=in process)</h2>
    <div class="main-container">
        <div class="status-container">
            <span id="statusCircle1" class="status-circle"></span>
            <div class="button-container">
                <button onclick="ChangeStatus(0)">RC ON</button>
                <button onclick="ChangeStatus(1)">RC OFF</button>
            </div>
        </div>

        <div class="status-container">
            <span id="statusCircle2" class="status-circle"></span>
            <div class="button-container">
                <button onclick="ChangeStatus(2)">Power ON</button>
                <button onclick="ChangeStatus(3)">Power OFF</button>
            </div>
        </div>
    </div>

    <!--main-->
    <h2>Table</h2>
    <div id="TableContainer"></div>
    <button id="applyButton" onclick="ApplyHV()">Apply</button>

    <script>
        const table_title = ["bus", "dev", "ch", "input (V)", "Voltage (V)", "Current (uA)", "about"];
        const mhv4_discription =
            ["tel1 Ea", "tel1 Eb", "tel1 Ec", "tel1 Ed",
                "tel2 Ea", "tel2 Eb", "tel2 Ec", "tel2 Ed"];

        async function DisplayData() {
            try {
                const response = await fetch("/mhv4_data");
                if (!response.ok) {
                    throw new Error("failed to fetch the MHV4 data");
                }
                const data = await response.json();
                console.log(data);
                setStatus(data);
                createTable(data);
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function setStatus(data) {
            const obj = JSON.parse(data);
            const circle1 = document.getElementById('statusCircle1');
            if (obj[0].is_rc) {
                circle1.className = 'status-circle green';
            } else {
                circle1.className = 'status-circle red';
            }

            const circle2 = document.getElementById('statusCircle2');
            if (obj[0].is_on) {
                circle2.className = 'status-circle green';
            } else {
                circle2.className = 'status-circle red';
            }
        }

        function createTable(data) {
            const container = document.getElementById('TableContainer');
            const table = document.createElement('table');
            table.setAttribute('border', '1');
            table.style.border = "2px solid green";

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            table_title.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // table data
            const tbody = document.createElement('tbody');
            const obj = JSON.parse(data);
            obj.forEach((mod, index) => {
                const row = document.createElement('tr');
                row.appendChild(createCell(mod.bus));
                row.appendChild(createCell(mod.dev));
                row.appendChild(createCell(mod.ch));

                // input field
                const inputCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.value = (mod.current) * 0.1;
                input.step = 0.1;
                input.min = 0;
                inputCell.appendChild(input);
                row.appendChild(inputCell);

                // SSE field (initially empty)
                row.appendChild(createCell(''));
                row.appendChild(createCell(''));

                row.appendChild(createCell(mhv4_discription[index]));

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        function createCell(text) {
            const cell = document.createElement('td');
            const celltext = document.createTextNode(text);
            cell.appendChild(celltext);
            return cell;
        }

        function setupSSE() {
            var index = 0;
            const eventSource = new EventSource('/sse');
            eventSource.onopen = function (event) {
                console.log("SSE connection opened:", event);
            };
            eventSource.onmessage = function (event) {
                console.log(index, "SSE message received:", event);
                const data = JSON.parse(event.data);
                updateTable(data);
                index++;
            };
            eventSource.onerror = function (error) {
                console.error("SSE connection opened:", error);
            };
        }

        function updateTable(data) {
            const table = document.querySelector('table');
            for (let i = 0; i < table.rows.length - 1; i++) {
                const row = table.rows[i + 1];
                const v_cell = row.cells[4];
                const c_cell = row.cells[5];

                if (data[0][i] < -999) {
                    v_cell.textContent = "read error!";
                } else {
                    v_cell.textContent = (data[0][i] * 0.1).toFixed(1);
                }
                if (data[1][i] < -999) {
                    c_cell.textContent = "read error!";
                } else {
                    c_cell.textContent = (data[1][i] * 0.001).toFixed(3);
                }
            }
        }

        // 0: RC on, 1: RC off, 2: Power on, 3: Power off
        async function ChangeStatus(num) {
            const circle1 = document.getElementById('statusCircle1');
            const circle2 = document.getElementById('statusCircle2');
            if (num == 0 || num == 1) {
                circle1.className = 'status-circle yellow';
            } else {
                circle2.className = 'status-circle yellow';
            }

            const response = await fetch("/status", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(num),
            });
            const result = await response.json();
            if (result) {
                if (num == 0) {
                    console.log("set RC ON");
                    circle1.className = 'status-circle green';
                } else if (num == 1) {
                    console.log("set RC OFF");
                    circle1.className = 'status-circle red';
                } else if (num == 2) {
                    console.log("set Power ON");
                    circle2.className = 'status-circle green';
                } else {
                    console.log("set Power OFF");
                    circle2.className = 'status-circle red';
                }
            }
        }

        async function ApplyHV() {
            const table = document.querySelector("table");
            table.style.border = "2px solid yellow";
            const rows = table.querySelectorAll("tr");
            let data = [];
            rows.forEach((row, index) => {
                if (index == 0) return;
                const input = row.cells[3].querySelector("input");
                if (isNaN(input.value) || Number(input.value) < 0) {
                    console.error("Input Error");
                    table.style.border = "2px solid red";
                    return;
                }
                const value = parseInt(Number(input.value) * 10);
                data.push(value);
            });
            console.log("send HV data", data);

            const response = await fetch("/apply", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (result) {
                table.style.border = "2px solid green";
                console.log("finish HV apply");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            DisplayData();
            setupSSE();
        });

    </script>
</body>

</html>